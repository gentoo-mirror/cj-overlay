#!/bin/bash

log="@GENTOO_PORTAGE_EPREFIX@/var/tmp/portage/*/*/temp/build.log"
cmd="tailf"

die() { echo -e "$*" >&2; exit 1; }

log_to_name() { sed "s@${log%%\**}\([^/]*\)/\([^/]*\)${log##*\*}@\2\t(\1)@"; }

if [ "$(echo $log)" = "$log" ]; then
  echo "No running build found"
  exit 0
elif [ -z "$1" ]; then
  echo "Running builds - use '${0##*/} NUMBER' to select"
  ls -1 $log | log_to_name | cat -n
elif [ -n "${1//[0-9]}" ]; then
  die "Argument of ${0##*/} should be a number"
else
  [ -n "${1//[0-9]}" ] && die "Argument should be a number"
  [ $1 -gt 0 ] || die "Argument should be bigger than 0"
  file="$(ls -1 $log | sed -n "${1}p")"
  if [ -z "${file}" ]; then
    die "Build number $1 not found" 
  elif [ ! -f "${file}" ]; then
    die "Build number $1 was gone in the meanwhile"
  else
    echo -ne "\033]0;$(echo Viewing: $file | log_to_name)\007"
    $cmd $file
  fi
fi
